Testing Keystone with QEMU
====================================

`QEMU <https://www.qemu.org>`_ is an open source machine emulator.
The latest QEMU supports RISC-V ISA.

Keystone was tested in a QEMU fork in RISC-V (`GitHub <https://github.com/riscv/riscv-qemu>`_).
The upstream QEMU is not currently supported due to several remaining issues (Ex: `See GitHub issue <https://github.com/keystone-enclave/keystone/issues/25>`_).
Fixes will be upstreamed in the future.

Installing Dependencies
----------------------------

We tested Keystone with QEMU Ubuntu 16.04/18.04 and derivatives.

Ubuntu
#######################

::

  sudo apt update sudo apt install autoconf automake autotools-dev bc \
  bison build-essential curl expat libexpat1-dev flex gawk gcc git \
  gperf libgmp-dev libmpc-dev libmpfr-dev libtool texinfo tmux \
  patchutils zlib1g-dev wget bzip2 patch vim-common lbzip2 python \
  pkg-config libglib2.0-dev libpixman-1-dev libssl-dev \
  device-tree-compiler expect makeself

Setup
----------------------------

In this stage, you will (1) install RISC-V toolchain, and (2) checkout git submodules.

You can quickly setup everything by running ``./fast-setup.sh``
::

  ./fast-setup.sh

This will download pre-compiled RISC-V tools and extract it to
``riscv`` directory and setup submodules.

If you want to compile RISC-V tools from source code, run
``./setup.sh`` instead. This may be necessary on some platforms due to
library issues.

To keep environment variables, add export
PATH=$PATH:<path/to/keystone>/riscv/bin to your .bashrc. You can also
manually run ``source source.sh`` to set the environment variables.

Init and Sync Submodules
########################

If you did not use ``fast-setup`` after checkout of the relevant
branch (``dev``, ``master``, etc)::

  git submodule sync --recursive
  git submodule update --init --recursive

For additional inormation, see `git submodules <https://git-scm.com/book/en/v2/Git-Tools-Submodules>`_.

Compile Sources
-----------------------------

Build All
#################

If you want to build all, simply run ``make``. This also rebuilds any
modifications.

``PATH`` must include the RISC-V tool path.

::

  make

If you want to manually build each individual component, please follow
the instructions below. If you run into any issues, check our
``Makefile`` and ``hifive.mk`` as they will always have up-to-date
build instructions.

Otherwise, skip to :ref:`LaunchQEMU`.

Build Runtime
##################

Runtime (i.e., Eyrie) can be built by a script in sdk.

::

  ./sdk/scripts/init.sh

This initializes the runtime source code at ``./sdk/rts`` based on the version specified in
``./sdk/rts/eyrie.version``.

For more usage of the script, try the script with ``--help`` flag.

Build RISC-V QEMU
##################

You should apply patches before building the QEMU.

::

  ./scripts/apply-patch.sh
  cd riscv-qemu
  ./configure --target-list=riscv64-softmmu,riscv32-softmmu
  make
  cd ..

Build Linux Kernel
################################################

This is handled as part of the top-level make, see ``hifive.mk`` for
details.

Build Berkeley Bootloader (BBL) with Keystone Security Monitor
##############################################################

This is handled as part of the top-level make, see ``hifive.mk`` for
details.

Optionally, add ``--with-target-platform=PLATFORM`` if you have a
platform specific set of files for the security monitor (defined in ``riscv-pk/sm/platform/``)

Build Root-of-Trust Boot ROM
###############################

::

  cd bootrom
  make
  cd ..

Build Keystone Driver
##############################

This is handled as part of the top-level make, see ``hifive.mk`` for
details.


.. _LaunchQEMU:

Launch QEMU
--------------------------------------

Now, you're ready to run Keystone.

The following script will run QEMU, start executing from the emulated silicon root of trust.
The root of trust then jumps to the SM, and the SM boots Linux!

::

   ./scripts/run-qemu.sh

Login as ``root`` with the password ``sifive``.


You can exit QEMU by ``ctrl-a``+``x`` or using ``poweroff`` command

Note that the launch scripts for QEMU will start ssh on a random
forwarded localhost port (this is to allow multiple qemu test runs on
the same development machine). The script will print what port it has
forwarded ssh to on start.

Insert Keystone Driver
##################################

Insert the keystone driver.

::

    insmod keystone-driver.ko

Run Tests
##################################

`fast-setup.sh` or `setup.sh` script has already built the SDK and small test enclaves and put the binaries into the buildroot root file system.
The source code of test enclaves are in `sdk/examples/tests` directory.

You can run the test enclaves by using a self-extracting keystone archive called `tests.ke` generated by the SDK.

::

  cd ./tests
  ./tests.ke
